<html>
<head>
  <title>WebMagic案例开发</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/602916 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="3034"/>
<h1>WebMagic案例开发</h1>

<div>
<span><div>聚焦爬虫</div><div><br/></div><div>创建Maven工程，添加依赖</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;parent&gt;</div><div>  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>  &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt;</div><div>  &lt;version&gt;2.0.2.RELEASE&lt;/version&gt;</div><div>&lt;/parent&gt;</div><div>&lt;dependencies&gt;</div><div>  &lt;dependency&gt;</div><div>    &lt;groupId&gt;junit&lt;/groupId&gt;</div><div>    &lt;artifactId&gt;junit&lt;/artifactId&gt;</div><div>    &lt;version&gt;4.11&lt;/version&gt;</div><div>    &lt;scope&gt;test&lt;/scope&gt;</div><div>  &lt;/dependency&gt;</div><div>  &lt;!--SpringMVC--&gt;</div><div>  &lt;dependency&gt;</div><div>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</div><div>  &lt;/dependency&gt;</div><div>  &lt;!--SpringData Jpa--&gt;</div><div>  &lt;dependency&gt;</div><div>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>    &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;</div><div>  &lt;/dependency&gt;</div><div>  &lt;!--Mysql连接包--&gt;</div><div>  &lt;dependency&gt;</div><div>    &lt;groupId&gt;mysql&lt;/groupId&gt;</div><div>    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</div><div>    &lt;version&gt;8.0.11&lt;/version&gt;</div><div>  &lt;/dependency&gt;</div><div>  &lt;!--工具包--&gt;</div><div>  &lt;dependency&gt;</div><div>    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</div><div>    &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;</div><div>  &lt;/dependency&gt;</div><div>  &lt;!--WebMagic核心包--&gt;</div><div>  &lt;dependency&gt;</div><div>    &lt;groupId&gt;us.codecraft&lt;/groupId&gt;</div><div>    &lt;artifactId&gt;webmagic-core&lt;/artifactId&gt;</div><div>    &lt;version&gt;0.7.4&lt;/version&gt;</div><div>  &lt;/dependency&gt;</div><div>  &lt;!--WebMagic扩展包--&gt;</div><div>  &lt;dependency&gt;</div><div>    &lt;groupId&gt;us.codecraft&lt;/groupId&gt;</div><div>    &lt;artifactId&gt;webmagic-extension&lt;/artifactId&gt;</div><div>    &lt;version&gt;0.7.4&lt;/version&gt;</div><div>  &lt;/dependency&gt;</div><div>  &lt;!--WebMagic对布隆过滤器的支持--&gt;</div><div>  &lt;dependency&gt;</div><div>    &lt;groupId&gt;com.google.guava&lt;/groupId&gt;</div><div>    &lt;artifactId&gt;guava&lt;/artifactId&gt;</div><div>    &lt;version&gt;16.0&lt;/version&gt;</div><div>  &lt;/dependency&gt;</div><div>&lt;/dependencies&gt;</div></div><div>添加springBoot配置文件（application.properties）</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#DB Configuration:</div><div>spring.datasource.driverClassName=com.mysql.jdbc.Driver</div><div>spring.datasource.url=jdbc:mysql://127.0.0.1:3306/phone</div><div>spring.datasource.username=root</div><div>spring.datasource.password=2019936206</div><div><br/></div><div><br/></div><div>#JPA Configuration:</div><div>spring.jpa.database=MySQL</div><div>spring.jpa.show-sql=true</div></div><div>添加日志配置文件log4j.properties</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><br/></div></div><div>创建包pojo</div><div>    在包中创建类 Phone</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@Entity</div><div>@Table(name=&quot;phone&quot;)</div><div>public class Phone{</div><div>    //主键</div><div>    @Id</div><div>    @GeneratedValue(strategy=GenerationType.IDENTITY)</div><div>    private Long pno;</div><div>    private String pname;</div><div>    private Long spu;</div><div>    private Long sku;</div><div>    private String title;</div><div>    private Double price;</div><div>    private String ppicture;</div><div>    private String url;</div><div>    private Data Time;</div><div>    get、set</div><div>}</div></div><div> 创建dao包 在包中创建PhoneDao接口</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>// JpaRePository泛型第一个为pojo类名，第二个为主键类型</div><div>public interface PhoneDao extends JpaRePository&lt;phone,Long&gt;{</div><div>}</div></div><div>  创建service包，在包中创建PhoneService接口</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>public interface PhoneService{</div><div>/*</div><div>    保存商品</div><div>    @param phone</div><div>*/</div><div>    public void save(Phone phone);</div><div>/*</div><div>    查询方法</div><div>*/</div><div>    public List&lt;Phone&gt; findAll();</div><div>}</div></div><div>  在service包创建PhoneService接口接口实现类PhoneServiceImol</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@Service</div><div>public class PhoneServiceImol implements PhoneService{</div><div>    @Autowired</div><div>    private PhoneDao phoneDao;</div><div>    @Override</div><div>    @Transactional</div><div>    public void save(Phone phone){</div><div>       //根据url和发布时间查询原有的数据</div><div>        Phone param=new Phone();</div><div>        param.setUrl(phone.getUrl());</div><div>        param.setTime(phone.getTime);</div><div>        //执行查询</div><div>        List&lt;Phone&gt; list=this.findPhone(param);</div><div>        //判断查询结果是否为空</div><div>        if(list.size()==0){</div><div>        //如果查询结果为空，表示信息不存在，或者已经更新了，需要新增或者更新数据库</div><div>        this.phoneDao.saveAndFlush(phone);</div><div>    }</div><div>}</div><div>    @Override</div><div>    public List&lt;Phone&gt; findAll(){</div><div>        //声明查询条件</div><div>    Example&lt;Phone&gt; example=Example.of(phone);</div><div>        //根据查询条件进行数据查询</div><div>    List&lt;Phone&gt; list=this.phoneDao.findAll(example);</div><div>    }</div><div>    public List&lt;Phone&gt; findPhone(Phone phone){</div><div>    </div><div>    }</div><div>}</div></div><div>在dao包的同级目录创建引导类</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@SpringBootApplication</div><div>//使用定时任务，需要开启定时任务时，需要添加注解</div><div>@EnableScheduling</div><div>public class Application{</div><div>    public static void mian(String[] args){</div><div>        SpringApplication.run(Application.class,args);</div><div>    }</div><div>}</div></div><div>实现数据抓取</div><div>使用定时任务，定时抓取最新的数据</div><div>创建task包，在task包下创建类PhoneTask</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@Component</div><div>public class PhoneTask implements PageProcessor{</div><div>   private Site site=Site.me()</div><div>            .setCharset(&quot;utf-8&quot;) //设置编码    </div><div>            .setTimeOut(10000)        //设置超时时间，单位是ms</div><div>            .setRetrySleepTime(3000)       //设置重试的间隔时间</div><div>            .setSleepTime(3)            //设置重置次数    </div><div>            ;</div><div>    public void process(page page){</div><div>        //解析页面，获取招聘信息详情的url地址</div><div>        list&lt;Selectable&gt; list=page.getHtml().css(&quot;div#resultList div.el&quot;).nodes();</div><div>        //判断获取到的集合是否为空</div><div>        if(list.size()==0){</div><div>            //如果为空，表示这是招聘详情页，解析页面，获取招聘信息，保存数据</div><div>            this.savePhone(page);</div><div>            }else{</div><div>            //不为空，则表示这是列表页，解析出详情页的url地址，放入任务队列中</div><div>            for(Selectable selectable:list){</div><div>                //获取url地址</div><div>                String phoneInfoUrl=selectable.links().toString();</div><div>                //把获得的url地址放入到任务队列中</div><div>                page.addTargetRequest(phoneInfoUrl);</div><div>                }</div><div>            //获取下一页的URL</div><div>            String bkUrl=page.gethtml().css(&quot;div.p_in li.bk&quot;).nodes().get(1).links().toString();</div><div>            //把url放入任务队列中</div><div>            page.addTargetRequest(bkUrl);</div><div>            }</div><div>        }</div><div><br/></div><div>    //解析页面，获取招聘信息，保存数据</div><div>    private void savePhone(Page page){</div><div>        //创建详情页对象</div><div>        Phone phone=new Phone();</div><div>        //解析页面</div><div>        Html html=page.getHtml();</div><div>        //获取数据，封装到对象中</div><div>        phone.setTime(html.css(&quot;div.cn p.cname a&quot;,&quot;text&quot;));   </div><div>        //把结果保存起来</div><div>        page.putField(&quot;phone&quot;,phone);</div><div>    }</div><div>    public Site getSite(){</div><div>        return site;</div><div>    }</div><div>    //initialDelay当任务启动后，等多久执行方法</div><div>    //fixedDelay每隔多久执行方法</div><div>  @Autowried</div><div>    private SpringDataPipeline springDatapipeline;</div><div>    @Scheduled(initialDelay=1000,fixedDelay=100*1000)</div><div>    public void process(){</div><div>        Spider.create(new PhoneTask())</div><div>                .addUrl(&quot;需要爬取的url&quot;)</div><div>                  .setScheduler(new QueueScheduler().setDuplicateRemover(new BloomFilterDuplicateRemover(10000000)))//设置布隆去重过滤器，指定最多对1000万条数据进行去重操作</div><div>                .thread(10)</div><div>                .addPipeline(this.springDataPipeline)</div><div>                .run();</div><div>    }</div><div>}</div></div><div>在task包下创建类SpringDataPipeline实现Pipeline接口</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@Component</div><div>public class SpringDataPipeline implements Pipeline{</div><div>    @Autowired</div><div>    private PhoneService phoneService;</div><div>    public void process(ResultItems resultItems,Task task){</div><div>       //获取封装好的详情对象</div><div>        Phone phone=resultItems.get(&quot;phone&quot;);</div><div>        //判断数据是否为空</div><div>        if(phone!=null){</div><div>            this.phoneService.save(phone);</div><div><br/></div><div>        }</div><div>        </div><div>    }</div><div>    </div><div>}</div></div><div><br/></div></span>
</div></body></html> 