<html>
<head>
  <title>第一个爬虫实例</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/602916 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="3000"/>
<h1>第一个爬虫实例</h1>

<div>
<span><div>准备数据库表</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>SET FOREIGN_KEY_CHECKS=0</div><div><br/></div><div><br/></div><div>DROP TABLE IF EXISTS `phone` CASCADE</div><div>;</div><div><br/></div><div><br/></div><div>CREATE TABLE `phone`</div><div>(</div><div>    `pno` BIGINT NOT NULL,</div><div>    `pname` VARCHAR(30),</div><div>    `ppicture` VARCHAR(200),</div><div>    `price` BIGINT,</div><div>    `spu` BIGINT,</div><div>    `sku` BIGINT,</div><div>    `title` VARCHAR(50),</div><div>    `url` VARCHAR(50),</div><div>    CONSTRAINT `PK_Table1` PRIMARY KEY (`pno`)</div><div>)</div><div>;</div><div><br/></div><div><br/></div><div>SET FOREIGN_KEY_CHECKS=1</div><div><br/></div><div><br/></div></div><div>在pom.xml添加父依赖</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;!--指定一个父--&gt;</div><div>&lt;parent&gt;</div><div>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</div><div>    &lt;version&gt;2.0.2.RELEASE&lt;/version&gt;</div><div>&lt;/parent&gt;</div></div><div>添加依赖</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;dependencies&gt;</div><div>    &lt;!--SpringMVC--&gt;</div><div>    &lt;dependency&gt;</div><div>        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</div><div>    &lt;/dependency&gt;</div><div>    &lt;!--SpringData Jpa--&gt;</div><div>    &lt;dependency&gt;</div><div>        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>        &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;</div><div>    &lt;/dependency&gt;</div><div>    &lt;!--Mysql连接包--&gt;</div><div>    &lt;dependency&gt;</div><div>        &lt;groupId&gt;mysql&lt;/groupId&gt;</div><div>        &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</div><div>        &lt;version&gt;8.0.11&lt;/version&gt;</div><div>    &lt;/dependency&gt;</div><div>    &lt;!--HttpClient--&gt;</div><div>    &lt;dependency&gt;</div><div>        &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt;</div><div>        &lt;artifactId&gt;httpclient&lt;/artifactId&gt;</div><div>    &lt;/dependency&gt;</div><div>    &lt;!--Jsoup--&gt;</div><div>    &lt;dependency&gt;</div><div>        &lt;groupId&gt;org.jsoup&lt;/groupId&gt;</div><div>        &lt;artifactId&gt;jsoup&lt;/artifactId&gt;</div><div>        &lt;version&gt;1.10.3&lt;/version&gt;</div><div>    &lt;/dependency&gt;</div><div>    &lt;!--工具包--&gt;</div><div>    &lt;dependency&gt;</div><div>        &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</div><div>        &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;</div><div>    &lt;/dependency&gt;</div><div>&lt;/dependencies&gt;</div></div><div>添加springBoot配置文件（application.properties）</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#DB Configuration:</div><div>spring.datasource.driverClassName=com.mysql.cj.jdbc.Driver</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">spring.datasource.url=jdbc:mysql://127.0.0.1:3306/phone</span></div><div>spring.datasource.username=root</div><div>spring.datasource.password=2019936206</div><div><br/></div><div>#JPA Configuration:</div><div>spring.jpa.database=MySQL</div><div>spring.jpa.show-sql=true</div></div><div>创建包pojo</div><div>    在包中创建类 Phone</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@Entity</div><div>@Table(name=&quot;phone&quot;)</div><div>public class Phone{</div><div>    //主键</div><div>    @Id</div><div>    @GeneratedValue(strategy=GenerationType.IDENTITY)</div><div>    private Long pno;</div><div>    private String pname;</div><div>    private Long spu;</div><div>    private Long sku;</div><div>    private String title;</div><div>    private Double price;</div><div>    private String ppicture;</div><div>    private String url;</div><div>    get、set</div><div>}</div></div><div>   创建dao包 在包中创建PhoneDao接口</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import org.springframework.data.jpa.repository.JpaRepository;</div><div>// JpaRePository泛型第一个为pojo类名，第二个为主键类型</div><div>public interface PhoneDao extends JpaRePository&lt;Phone,Long&gt;{</div><div>}</div></div><div>    创建service包，在包中创建PhoneService接口</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package service;</div><div>import pojo.Phone;</div><div>import java.util.List;</div><div>public interface PhoneService{</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">/*</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">    保存商品</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">    @param phone</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">*/</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">    public void save(Phone phone);</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">/*</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">    查询方法</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">*/</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">    public List&lt;Phone&gt; findAll(Phone phone);</span></div><div>}</div></div><div>    在service包创建PhoneService接口接口实现类PhoneServiceImpl</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@Service</div><div>public class PhoneServiceImpl implements PhoneService{</div><div>    @Autowired</div><div>    private PhoneDao phoneDao;</div><div>    @Override</div><div>    @Transactional</div><div>    public void save(Phone phone){</div><div>    this.phoneDao.save(phone);    </div><div>}</div><div>    @Override</div><div>    public List&lt;Phone&gt; findAll(Phone phone){</div><div>        //声明查询条件</div><div>    Example&lt;Phone&gt; example=Example.of(phone);</div><div>        //根据查询条件进行数据查询</div><div>    List&lt;Phone&gt; list=this.phoneDao.findAll(example);</div><div>    return list;</div><div>    }</div><div>}</div></div><div>在dao包的同级目录创建包application，在包下创建引导类</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@SpringBootApplication</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">//使用定时任务，需要开启定时任务时，需要添加注解</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">@EnableScheduling</span></div><div>public class Application{</div><div>    public static void mian(String[] args){</div><div>        SpringApplication.run(Application.class,args);</div><div>    }</div><div>}</div></div><div><br/></div><div>封装HttpClient</div><div>创建util包，在util包下创建HttpUtils</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@Component</div><div>public class HttpUtiles{</div><div>    private PoolingHttpClientConnectionManager cm;</div><div>    public HttpUtils(){</div><div>        this.cm=new PoolingHttpClientConnectionManager();</div><div>    //设置最大的连接数</div><div>    this.cm.setMaxTotal(100);</div><div>    //设置每个主机的最大连接数</div><div>    this.cm.setDefaultMaxPerRoute(10);  </div><div>    }    </div><div>    //根据请求地址下载页面数据</div><div>    public String doGetHtml(String url){</div><div>        //获取HttpClient对象</div><div>        CloseableHttpClient httpClient=HttpClients.custom().setConnectionManager(this.cm).build();</div><div>        //创建httpGet请求对象，设置url地址</div><div>        HttpGet httpGet=new HttpGet(url);</div><div>        //设置请求信息</div><div>        httpGet.setConfig(this.getConfig());</div><div>        CloseableHttpResponse response=null;</div><div>       </div><div>       try{</div><div>        //使用httpClient发起请求，获取响应</div><div>        response=httpClient.execute(httpGet);</div><div>         //解析响应，返回结果</div><div>if(response.getStatusLine().getStatusCode()==200){</div><div>    //判断响应体是否为空，如果不为空，就可以使用EntityUtils</div><div>    if(response.getEntity()!=null){</div><div>        String content=EntityUtils.toString(response.getEntity(),&quot;utf8&quot;</div><div>);</div><div>    return content;</div><div>        } </div><div>    }</div><div>        }catch(IOException e){</div><div>            e.printStackTrace();</div><div>        }finally{</div><div>        //关闭response</div><div>        if(response!=null){</div><div>            response.close();</div><div>        }</div><div>        }</div><div>      return &quot;&quot;; </div><div>    }</div><div>    <b>//下载图片，返回图片名称</b></div><div>    public String dogetImage(String url){</div><div>        //获取HttpClient对象</div><div>        CloseableHttpClient httpClient=HttpClients.custom().setConnectionManager(this.cm).build();</div><div>        //创建httpGet请求对象，设置url地址</div><div>        HttpGet httpGet=new HttpGet(url);</div><div>        //设置请求信息</div><div>        httpGet.setConfig(this.getConfig());</div><div>        CloseableHttpResponse response=null;</div><div>       </div><div>       try{</div><div>        //使用httpClient发起请求，获取响应</div><div>        response=httpClient.execute(httpGet);</div><div>         //解析响应，返回结果</div><div>if(response.getStatusLine().getStatusCode()==200){</div><div>    //判断响应体是否为空，如果不为空，就可以使用EntityUtils</div><div>    if(response.getEntity()!=null){</div><div>        //下载图片</div><div>        //获取图片的后缀</div><div>        String extName=url.substring(url.lastIndexOf(&quot;.&quot;));</div><div>        //创建图片名，重命名图片</div><div>String picName=UUID.randomUUID().toString()+extName;</div><div>        //下载图片</div><div>        //声明OutPutStream</div><div>    OutputStream outputStream =new FileOutputStream(new File(&quot;C:\Users\爱德华\Desktop\imgs\\&quot;+picName));</div><div>response.getEntity().writeTo(outputStream);</div><div>        //返回图片名称</div><div>        return picName;</div><div>        }</div><div>    }</div><div>        }catch(IOException e){</div><div>            e.printStackTrace();</div><div>        }finally{</div><div>        //关闭response</div><div>        if(response!=null){</div><div>            response.close();</div><div>        }</div><div>        }</div><div>        //如果下载失败，返回空字符串</div><div>      return &quot;&quot;;</div><div><br/></div><div><br/></div><div>    }</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">    //设置请求信息</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">    private RequestConfig getConfig(){</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">        RequestConfig config =RequestConfig.custom()</span></div><div>            </div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">                .setConnectTimeout(1000)</span>//创建连接的最长时间</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">                .setConnectionRequestTimeout(500</span><span style="font-family: Monaco; font-size: 9pt;">)</span>//获取连接的最长时间</div><div><span style="font-family: Monaco; font-size: 9pt;">                .setSocketTimeout(10*1000)//数据传输的最长时间</span></div><div><span style="font-family: Monaco; font-size: 9pt;">                .build();</span></div><div><span style="font-family: Monaco; font-size: 9pt;">        return config;</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">    }</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">}</span></div></div><div><br/></div><div>实现数据抓取</div><div>使用定时任务，定时抓取最新的数据</div><div>创建task包，在task包下创建类PhoneTask</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@Component</div><div>public class PhoneTask{</div><div>    int jilu;</div><div>    @Autowired</div><div>    private HttpUtils httpUtils;</div><div>    @Autowired</div><div>    private PhoneService phoneService;</div><div>    private static final ObjectMapper MAPPER=new ObjectMapper();</div><div>    //当下载任务完成后，间隔多长时间进行下一次任务</div><div>    //100*1000 100秒</div><div>    @Scheduled(fixedDelay=100*1000)</div><div>    public void phoneTask()throws Exception{</div><div>    //声明需要解析的初始地址</div><div>    String url=&quot;https://search.jd.com/Search?keyword=%E6%89%8B%E6%9C%BA&amp;enc=utf-8&amp;wq=%E6%89%8B%E6%9C%BA&amp;pvid=855eb903b131414680955980c326a885&amp;pag=&quot;;</div><div>    //按照页码遍历页面</div><div>    for(int i=1;i&lt;=10;i+=2){</div><div>        httpUtils.doGetHtml(url+i);</div><div>        //解析页面，获取商品数据并存储</div><div>        this.parse(html);</div><div>    }</div><div>   </div><div>    System.out.println(&quot;第&lt;&quot;+jilu+&quot;&gt;次&quot;+&quot;手机数据抓取完毕&quot;);</div><div>     jilu++;</div><div>    }</div><div>    //解析页面，获取商品数据并存储</div><div>    private void parse(String html){</div><div>        //解析html获取Document</div><div>        Document doc=Jsoup.parse(html);</div><div>        //获取spu</div><div>        Elements spuEles=doc.select(&quot;div#J_goodsList &gt;ul &gt;li&quot;);</div><div>        for(Element spuEle:spuEles){</div><div>            //获取到spu</div><div>            long.spu=spuEle.attr(&quot;data-spu&quot;);</div><div>            //获取sku</div><div>            Element skuEles=spuEle.select(Li.ps-item);</div><div>            for(Element skuEle:skuEles){</div><div>                //获取sku</div><div>             long sku=Long.parseLong(skuEle.select(&quot;[data-sku]&quot;).attr(&quot;data-sku&quot;));</div><div>                //根据sku查询商品数据</div><div>                Phone phone=new Phone();</div><div>                item.setSku(sku);</div><div>                List&lt;Phone&gt;                 list=this.phoneService.findAll(item);</div><div>                //如果商品存在，就进行下一个循环，不存在则保存</div><div>                if(list.size()&gt;0)</div><div>                //如果商品存在，就进行下一个循环，不保存</div><div>                continue;</div><div>                //设置商品的spu</div><div>                phone.setSpu(spu);</div><div>                //获取商品的详情的url</div><div>                String phoneUrl=&quot;https://item.jd.com/&quot;+sku+&quot;.html&quot;;</div><div>                phone.setUrl(phoneUrl);</div><div>                //获取商品的图片</div><div>                String picUrl=&quot;https:&quot;+skuEle.select(&quot;img[data-sku]&quot;).first().attr(&quot;src&quot;);</div><div>                picUrl=picUrl.replace(&quot;n9&quot;,&quot;n1&quot;);</div><div>                String picName=this.httpUtils.doGetImage(picUrl);</div><div>                phone.setPic(picName);</div><div>                //获取商品的价格</div><div>                this.httpUtils.doGetHtml(&quot;https://p.3.cn/prices/mgets?skuIds*J_&quot;+sku);</div><div>                double price=MAPPER.readTree(priceJson).get(0),get(&quot;p&quot;).asDouble();</div><div>                phone.setPrice(price);</div><div>                //获取商品的标题</div><div>                String phoneInfo=this.httpUtils.doGetHtml(phoneUrl);</div><div>                String title=Jsoup.parse(phoneInfo).select(&quot;div.sku-name&quot;).text();</div><div>               </div><div>                phone.setTitle(title);</div><div>                //保存商品数据到数据库中</div><div>                this.phoneService.save(phone);</div><div>            }</div><div>        }</div><div>    }</div><div>}</div></div><div><br/></div></span>
</div></body></html> 