<html>
<head>
  <title>DockerFile</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/602916 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="5544"/>
<h1>DockerFile</h1>

<div>
<span><div>用来构建docker 镜像的文件！命令参数脚本！</div><div><br/></div><div><span style="font-weight: bold;">构建步骤：</span></div><div>    1、编写一个dockerfile 文件</div><div>    2、docker build 构建称为一个镜像</div><div>    3、docker run运行镜像</div><div>    4、docker push 发布镜像（DockerHub、阿里云镜像仓库）    </div><div><br/></div><div><br/></div><div><span style="font-size: 14pt; font-weight: bold;">DockerFile构建过程</span></div><div>    <span style="font-size: 12pt; font-weight: bold;">基础知识：</span></div><div>        1、每个保留关键字（指令）都必须是大写字母；</div><div>        2、执行从上到下顺序执行；</div><div>        3、#表示注释</div><div>        4、每一个指令都会创建提交一个新的镜像层，并提交！</div><div><br/></div><div><img src="DockerFile_files/Image.png" type="image/png" data-filename="Image.png" width="1043"/></div><div>    dockerfile是面向开发的，以后要发布项目，作镜像，就需要编写dockerfile文件！</div><div>    </div><div>    DockerFile：构建文件。定义了一切的步骤；</div><div>    DockerImages：通过DockerFile构建生成的镜像，最终发布和运行的产品；</div><div>    Docker容器：容器就是镜像运行起来提供服务的服务器；</div><div><br/></div><div><span style="font-size: 14pt; font-weight: bold;">DockerFile命令</span></div><div><font style="font-size: 14pt;"><br/></font></div><div><img src="DockerFile_files/Image [1].png" type="image/png" data-filename="Image.png" width="853"/></div><div>    </div><div>    FROM                  #基础镜像 </div><div>    MAINTAINER      #镜像是谁写的，姓名+邮箱</div><div>    RUN                    #镜像都贱的时候需要运行的命令</div><div>    ADD                    #步骤，tomcat镜像，这个tomcat压缩包，添加内容</div><div>    WORKDIR            #镜像的工作目录</div><div>    VOLUME              #挂载的目录</div><div>    EXPOSE                #暴露端口配置</div><div>    CMD                     #指定这个容器启动的时候要运行的命令， 只有最后一会生效，可被替代</div><div>    ENTRYPOINT        #指定这个容器启动时要运行的命令，可以追加命令</div><div>    ONBUILD              #当构建一个被继承 DockerFile 这个时候就会运行ONBUILD指令。</div><div>    COPY                    #类似于ADD，将文件拷贝到镜像中</div><div>    ENV                       #构建的时设置环境变量</div><div>    </div><div><br/></div><div><font style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(222, 87, 0); font-style: italic; font-weight: bold;">实战一：构建自己的cento</span></font><font style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(222, 87, 0); font-style: italic; font-weight: bold;">s</span></font></div><div>    （使其拥有vim软件和ifconfig功能）</div><div><span style="font-weight: bold;">Docker Hub中99%的镜像都是从 scratch 开始                                                                        </span>（FROM scratch）</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>FROM centos</div><div>MAINTAINER likang&lt;lkang_0x@163.com&gt;</div><div>ENV MYPATH /usr/local    #ENV 是以键值对的形式指定的</div><div>WORKDIR $MYPATH</div><div>RUN yum -y install vim</div><div>RUN yum -y install net-tools    #网络常用的命令</div><div><br/></div><div>EXPOSE 80</div><div>CMD echo $MYPATH</div><div>CMD echo &quot;----end----&quot;</div><div>CMD /bin/bash  </div><div><br/></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">#构建镜像</span></div><div>docker build -f dockerfile文件路径 -t 镜像名 镜像生成的路径    </div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#测试运行</div><div>run</div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#查看镜像的构建历史</div><div>docker history 镜像id</div></div><div><br/></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt; font-weight: bold;">CMD和ENTRYPOINT的区别：    </span></div><div><span style="font-size: 12pt; font-weight: bold;">    CMD是替换，ENTRYPOINT是追加。</span></div><div>    测试CMD        </div><div><img src="DockerFile_files/Image [2].png" type="image/png" data-filename="Image.png" width="1103"/></div><div><img src="DockerFile_files/Image [3].png" type="image/png" data-filename="Image.png" width="1105"/></div><div>    测试 ENTRYPOINT</div><div><img src="DockerFile_files/Image [4].png" type="image/png" data-filename="Image.png" width="1106"/></div><div><img src="DockerFile_files/Image [5].png" type="image/png" data-filename="Image.png" width="1106"/></div><div><img src="DockerFile_files/Image [6].png" type="image/png" data-filename="Image.png" width="1108"/></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt; font-weight: bold;">实战二：Tomcat镜像</span></div><div>    1、准备：tomcat压缩包，jdk压缩包，镜像文件,准备文件readme.txt</div><div>    2、编写镜像文件</div><div>        编写dockerfile文件，官方命名Dockerfile，build的时候会自动寻找这个文件，不需要-f 指定路径了。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>FROM centos:8</div><div>MAINTAINER likang&lt;lkang_0x@163.com&gt;</div><div>#cpoy readme.txt进镜像</div><div>COPY readme.txt /usr/local/readme.txt</div><div>#将JDK和Tomcat解压到镜像，ADD指令自动解压</div><div>ADD jdk-8u301-linux-x64.tar.gz /usr/local</div><div>ADD apache-tomcat-10.0.10.tar.gz /usr/local</div><div># 下载vim命令</div><div>RUN yum -y install vim</div><div>#配置环境变量</div><div>ENV MYPATH /usr/local</div><div>#指定镜像的工作目录</div><div>WORKDIR $MYPATH</div><div>ENV JAVA_HOME /usr/local/jdk1.8.0_301</div><div>ENV CLASSPATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</div><div>ENV CATALINA_HOME /usr/local/apache-tomcat-10.0.10</div><div>ENV CATALINA_BASH /usr/local/apache-tomcat-10.0.10</div><div>ENV PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/bin:$CATALINA_HOME/lib</div><div>EXPOSE 8080</div><div><br/></div><div><br/></div><div>#启动镜像执行的命令，可以&amp;&amp;多条。</div><div>CMD /usr/local/apache-tomcat-10.0.10/bin/startup.sh &amp;&amp; tail -F /usr/local/apache-tomcat-10.0.10/logs/catalina.out</div><div><br/></div><div><br/></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div></div><div>    3、构建镜像</div><div>    4、启动镜像</div><div>    5、访问测试</div><div>    6、发布项目（由于做了卷挂载，直接在本地编写项目就可以发布了）</div><div>    7、运行测试</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font face="Monaco">出现的问题：<b>1、在构建镜像的时候报错：</b></font></div><div>    ADD failed: file not found in build context or excluded by .dockerignore: stat home/likang/tools/jdk-8u301-linux-aarch64.tar.gz: file does not exist</div><div>    在网上查找原因： dockerfile 不能获取 父目录</div><div>    解决：将压缩包放在 dockerfile的同级目录，build成功。</div><div><font face="Monaco"><br/></font></div><div><font face="Monaco">                <b>2、在ADD的时候</b></font></div><div><font face="Monaco"><b>    开始的时候是：</b></font></div><div>     ADD jdk-8u301-linux-aarch64.tar.gz /usr/local/</div><div>     ADD apache-tomcat-10.0.10.tar.gz /usr/local/</div><div><font face="Monaco">    然后创建的容器第二个</font>apache-tomcat-10.0.10.tar一直是空目录。</div><div>    更改为：</div><div>        ADD jdk-8u301-linux-aarch64.tar.gz /usr/local</div><div>        ADD apache-tomcat-10.0.10.tar.gz /usr/local</div><div>    之后，两个文件就都ok了。</div><div>   这个原因可能是因为：ADD指令的功能太多，这种解释似乎是ADD尝试做的太多了，让用户有些疑惑。很明显，没人想要打破向后兼容性。所以决定新增一个行为更加明确的指令。</div><div>    <b><font color="#FF0000">Docker 团队的建议是在大多数情况下使用COPY。拷贝文件的原则：使用COPY（除非你明确你需要ADD）</font></b></div><div><b><font color="#FF0000">    然后更改为</font></b></div><div><b><font color="#FF0000">     </font></b>ADD jdk-8u301-linux-aarch64.tar.gz /usr/local/</div><div>     ADD apache-tomcat-10.0.10.tar.gz /usr/local/</div><div>    发现又好了，我觉的可能和docker的分层文件系统有关（可能存在缓存吧）。</div><div>    发现是 ENV CATALINA_HOME /usr/local/tomcat路径 出现的问题。汗汗汗！！！！</div><div><b><font color="#FF0000">        3、这个应该是最后一个问题，在JDK下载错误之后，在更改JDK之后，所有的配置也都没有问题，但是docker容器一直运行不起来。因为dockerfile文件中最后执行的命令是：</font></b>CMD /usr/local/apache-tomcat-10.0.10/bin/startup.sh</div><div>它运行一次之后，就结束了（这个命令就结束了，而不是tomcat服务结束了），容器就跟着关闭了，更改为：CMD /usr/local/apache-tomcat-10.0.10/bin/startup.sh &amp;&amp; tail -F /usr/local/apache-tomcat-10.0.10/logs/catalina.out</div><div><br/></div><div>   <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"> </span><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">tail -f filename 会把 filename 文件里的最尾部的内容显示在屏幕上，并且不断刷新，只要 filename 更新就可以看到最新的文件内容。所以这条命令是一直在前台运行的，容器不会关闭。 (docker容器必须要有一个前台进程，否则就会自己关闭)</span></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">    tomcat在windows下启动是通过startup.bat脚本，其中都是一些dos命令。会启动一个命令行并显示日志信息。但是在linux下启动通过start.sh文件，是shell脚本文件，在后台运行，并不会启动前台进程。</span></div></div><div>    </div><div><span style="font-size: 14pt; font-weight: bold;"> 以上的实践：</span><span style="font-size: 14pt; font-weight: bold;"> </span><span style="font-size: 14pt; font-weight: bold;">尝试了很多次报错：最后发现是JDK下载错误</span><span style="font-size: 14pt;">。</span></div><div>    下载的JDK是 jdk-8u301-linux-aarch64.tar.gz ，基于APM（CPU）的JDK，更改为</div><div><img src="DockerFile_files/Image [7].png" type="image/png" data-filename="Image.png" width="1061"/></div><div><br/></div><div><img src="DockerFile_files/Image [8].png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>命令：</div><div><span>    docker save -o 压缩路径 镜像ID/镜像名</span><br/></div><div><span><span>    docker load -i 读取路径</span><br/></span></div></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 