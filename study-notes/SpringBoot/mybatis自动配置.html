<html>
<head>
  <title>mybatis自动配置</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/602916 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="6334"/>
<h1>mybatis自动配置</h1>

<div>
<span><div><b><font style="font-size: 12pt;">一、Springboot整合mybatis注解版</font></b></div><div><span>    相关依赖：</span><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;dependency&gt;</div><div>   &lt;groupId&gt;mysql&lt;/groupId&gt;</div><div>   &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</div><div>   &lt;scope&gt;runtime&lt;/scope&gt;</div><div>&lt;/dependency&gt;</div><div>&lt;dependency&gt;</div><div>   &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</div><div>   &lt;artifactId&gt;druid&lt;/artifactId&gt;</div><div>   &lt;version&gt;1.1.12&lt;/version&gt;</div><div>&lt;/dependency&gt;</div><div>&lt;dependency&gt;</div><div>   &lt;groupId&gt;log4j&lt;/groupId&gt;</div><div>   &lt;artifactId&gt;log4j&lt;/artifactId&gt;</div><div>   &lt;version&gt;1.2.17&lt;/version&gt;</div><div>&lt;/dependency&gt;</div><div>&lt;dependency&gt;</div><div>   &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;</div><div>   &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;</div><div>   &lt;version&gt;1.3.1&lt;/version&gt;</div><div>&lt;/dependency&gt;<span>    </span></div></div><div><span>    mybaties-starter是mybaties基于springboot 开发的配置类，<span>    </span><span>    </span><span>    </span>springboot的自动配置包命名规则（约定）：spring-boot-starter-starter名</span><br/></div><div><span>    </span><span>    </span>第三方配置包命名规则：starter名-spring-boot-starter</div><div><br/></div><div><span>    步骤：</span><br/></div><div><span><span>    </span><span>    1、配置数据源相关属性</span><br/></span></div><div><span><span>    </span><span>    2、数据库建表</span><br/></span></div><div><span>    </span><span>    3、创建javaBean（实体类）</span></div><div><span><span>    </span><span>    4、创建mapper接口，接口上需要有@Mapper注解，作用是让该接口被MapScan扫描到。不加Mapper的话需要添加对应的扫描器，扫描该包下的所有Mapper。</span><br/></span></div><div><span><span>    </span><span>    5、编写对应方法（sql语句）</span><br/></span></div><div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span>@Mapper</span></div><div><span>public interface PersonMapper{</span></div><div><span>    @Select(&quot;select * from person t where t.pid=#{pid}&quot;)</span></div><div><span>    public Person selectById(int pid);</span></div><div><span><br/></span></div><div><span><br/></span></div><div><span>    @Select(&quot;select * from person&quot;)</span></div><div><span>    public List&lt;Persion&gt; selectAll();</span></div><div><span><br/></span></div><div><span><br/></span></div><div><span>    @Options(useGeneratedKeys = true,keyProperty=&quot;pid&quot;)//设置pid为主键</span></div><div><span>    @Insert(&quot;insert into person(pid,panme,addr)values(#{pid},#{panme},#{addr})&quot;)</span></div><div><span>    public void insert(Person p);</span></div><div><span><br/></span></div><div><span><br/></span></div><div><span>    @delete(&quot;delete from person where pid =#{pid} &quot;)</span></div><div><span>    public void delete(int pid);</span></div><div><span>}</span></div></div><div><span><span>    添加MapperScan指定扫描范围</span><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">//在主启动类上添加@MapperScan注解</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">@MapperScan(&quot;需要扫描的包路径&quot;)</span></div></div><div><br/></div><div>Mybatis个性化设置：（也可以通过配置文件来设置）</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@Configuration</div><div>public class MybatisConfig{</div><div><span>    @Bean</span><br/></div><div><span>    public ConfigurationCustomizer customizer(){</span></div><div><span>    </span><span>    return new ConfigurationCustomizer(){</span></div><div><span>    </span><span>    </span><span>    public void customize(org.apache.ibatis.session.Configuration configuration){</span></div><div><span><span>    </span><span>    </span><span>    </span><span>    configuration.setMapUnderscoreToCamelCase(true);//设置数据库字段 _和java 驼峰模式的匹配问题</span><br/></span></div><div><span><span><span>    </span><span>    </span><span>    </span>}</span><br/></span></div><div><span><span><span>    </span><span>    </span>}</span><br/></span></div><div><span><span>    </span>}</span><br/></div><div>}</div></div><div><span>    </span>mybatis-spring 注解开发（原理）：</div><div><img src="mybatis自动配置_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><img src="mybatis自动配置_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><b><font style="font-size: 12pt;">二、Mybatis配置文件方式整合</font></b></div><div><span>    1、创建mapper映射文件和接口</span><br/></div><div><span>    2、创建mybaties的配置文件（也可以不创建，所有的东西都在applciation.yml中指定</span><span style="color: unset; font-family: unset; font-size: unset;">）</span></div><div><span><span>    3、在applciation.yml设置mybatis的属性配置</span><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span>mybatis:</span></div><div><span><span>    #如果使用xml方式对mybatis进行配置需要指定xml文件的路径</span><br/></span></div><div><span>    config-location: classpath:sqlMapConfig</span><br/></div><div><span>    </span></div><div><span><span><span>    </span>#直接在application.yml进行设置</span><br/></span></div><div><span><span>    mapper-locations: classpath:mapper/*.xml</span><br/></span></div><div><span>    #</span>设置数据库字段 _和java 驼峰模式的匹配问题</div><div><span><span><span>    </span>configuration:</span><br/></span></div><div><span><span>    </span><span>    map-underscore-to-camel-case: true</span><br/></span></div></div><div>注意：config-location和configuration不能同时存在，同时存在说明既有applciation.yml的配置，又有xml的配置，这是不合理的。</div><div><br/></div><div><br/></div><div>原理：</div><hr/><div>mybatis自动配置铺垫：Session工厂</div><div><span>    SqlSessionFactoryBean和SqlSessionFactoryBuilder的区别：</span><br/></div><div><span>    答<font style="font-size: 9pt;"><span> ： </span></font></span><font style="font-size: 9pt;"> <span style="color: rgb(51, 51, 51); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimHei, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;">mybatis中使用SqlSessionFactoryBuilder创建session工厂;</span></font></div><div><span style="color: rgb(51, 51, 51); font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, SimHei, SimSun; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><font style="font-size: 9pt;">   <span>    </span>     <span>    </span>mybatis-spring整合时使用SqlSessionFactoryBean替代SqlSessionFactoryBuilder来创建session工厂</font></span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51);"><img src="mybatis自动配置_files/20210127120143279.png" type="image/png" data-filename="20210127120143279.png"/></span></div><div><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word;"><span>    </span>sqlSessionFactoryBean，主要作用是通过getObject得到sqlSessionFactory,同时可以设置数据源，mybatis基本配置等。</span></div><div><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word;"><span>    </span>sqlSessionFactory，用于创建sqlSession的工厂方法。</span></div><div><span style="box-sizing: border-box; outline: 0px; overflow-wrap: break-word;">sqlSession，执行sql命令的会话。</span></div><div><span>    </span>SqlSessionTemplate是sqlSession的实现类，是线程安全的。里面有一个动态代理的SqlSession sqlSessionProxy;代理sqlSessionProxy执行invoke方法的时候，每次invoke方法都是新生成一个SqlSession来执行，这样就保持了线程安全。</div><div><span style="color: unset; font-family: unset; font-size: unset;"><span>    </span>还有一个点，getMapper()方法是得到一个mapper接口的代理对象，且会传入this即本sqlSessionTemplate,最终调用sql语句的时候还是使用代理的sqlSessionProxy(实际还是invoke的新的SqlSession)。【记住，2个动态代理】</span></div><div><span style="color: unset; font-family: unset; font-size: unset;"><span>    </span></span>SqlSessionManager是sqlSession的实现类，是线程安全的。里面也有一个动态代理的SqlSession sqlSessionProxy;同时维护一个ThreadLocal localSqlSession，所以代理sqlSessionProxy执行invoke方法的时候，就是拿各自线程的ThreadLocal的SqlSession。</div><div>   <font><font style="font-size: 10pt;"><font> </font><span style="box-sizing: border-box; outline: 0px; color: rgb(77, 77, 77); line-height: 26px; overflow-wrap: break-word;"><font>DefaultSqlSession是sqlSession的实现类，普通的一次请求，不安全的。</font></span></font></font><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><font><span style="box-sizing: border-box; outline: 0px; color: rgb(77, 77, 77); line-height: 26px; overflow-wrap: break-word;"><font><span>    </span></font></span></font><span style="box-sizing: border-box; outline: 0px; color: rgb(77, 77, 77); line-height: 26px; overflow-wrap: break-word;">MapperFactoryBean，创建mapper的工厂类，getObject()得到mapper接口的动态代理生成的代理类，它继承SqlSessionDaoSupport来间接操作SqlSessionTemplate。即getObject()-&gt;getMapper()</span></font></div><div><font style="font-size: 10pt;"><span style="box-sizing: border-box; outline: 0px; color: rgb(77, 77, 77); line-height: 26px; overflow-wrap: break-word;"><span>    </span></span><span style="color: rgb(77, 77, 77);">@MapperScan，会扫描目标目录的所有Mapper接口，并名字定义成mapper接口名，但是class类名是MapperFactoryBean，里面的有一个属性是mapper的权限名。如此启动项目，加载单例bean到上下文容器的时候，调用getObject会调用SqlSessionTemplate的getMapper()，得到代理mapper对象。</span></font></div><div><font style="font-size: 10pt;"><span style="color: rgb(77, 77, 77);"><span>    </span></span><span style="color: rgb(77, 77, 77);">@Mapper，若没有使用@MapperScan【@ConditionalOnMissingBean({ MapperFactoryBean.class, MapperScannerConfigurer.class })】，而使用@Mapper，原理也类似，会扫描主启动类目录下的所有标注了@Mapper的mapper接口文件</span></font></div><div><span style="font-size: 12pt; color: rgb(77, 77, 77);"><br/></span></div><div>代理对象:（Mapper--&gt;dao对象）</div><div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span><br/></span></div></div>
会话模板：</div><div><span><br/></span></div><div><span>    整体流程：先创建Mapper的代理，代理对象在执行其中方法的时候，再去调用sqlsession的代理对象完成session的打开和关闭以及前后事务的处理。</span></div><div><span><br/></span></div><div><b><font style="font-size: 12pt;"><br/></font></b></div><div><b><font style="font-size: 12pt;">@MapperScan扫描原理</font></b></div><div><span>    1、在mybatis的配置文件中指定扫描包：</span><br/></div><div><span>&lt;mybatis:scan/&gt;</span></div><div>&lt;mybatis:scan/&gt;和spring中&lt;context:component-scan/&gt;是相似的。<span><span>  </span><br/></span></div><div><span><span>    2、使用@MapperScan</span><br/></span></div><div><span><span>    3、使用MapperScannerConfigurer（在spring配置文件）</span><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">&lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"><span>    &lt;property name=&quot;basePackage&quot; value=&quot;org.mybatis.spring.sample.mapper&quot;/&gt;</span><br/></span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">&lt;/bean&gt;</span></div></div><div><span><br/></span></div><div><span><br/></span></div><div><span><span><span>Mybaits自动配置源码解析    </span><br/></span><br/></span></div><div><br/></div><div><br/></div></div></span>
</div></body></html> 