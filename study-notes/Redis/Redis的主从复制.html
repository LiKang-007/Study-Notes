<html>
<head>
  <title>Redis的主从复制</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/602916 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="5522"/>
<h1>Redis的主从复制</h1>

<div><span><div>      <span style="font-size: 12pt; font-weight: bold;">  主从复制：</span></div><div>                    主机数据更新后根据配置和策略，自动同步到从机的master/slave机制，Master以写为主，Slave以读为主。</div><div>一般是主少从多，主负责写（可以读），从负责读（不能写），主写同步复制到从。</div><div><br/></div><div>        <span style="font-weight: bold;">一主二从：</span></div><div>            一主二从原理：</div><div>                1、配从（库）不配主（库）</div><div>                2、配从（库）：slaveof 主库IP 主库端口号</div><div>                3、主写从读、读写分离</div><div><br/></div><div>      <span style="font-weight: bold;">  搭建一主二从：</span></div><div>            <span style="font-weight: bold;">1、搭建三台redis服务：使用一个redis模拟三台redis服务</span></div><div>                    提供三分redis配置文件：redis6379.conf、redis6380.conf、redis6381.conf</div><div>            <span style="font-weight: bold;">2、修改三份配置文件：以redis6379为例子</span></div><div>                            port 6379</div><div>                            pidfile ~/redisLog/redis_6379.pid</div><div>                            logfile &quot;6379.log&quot;</div><div>                            dbfilename dump6379.rdb</div><div>            <span style="font-weight: bold;">3、分别使用三个Redis配置文件，启动三个redis服务：</span></div><div>                            redis-server redis6379.conf &amp;</div><div>                            redis-server redis6380.conf &amp;</div><div>                            redis-server redis6381.conf &amp;</div><div>            <span style="font-weight: bold;">4、通过redis客户端分别连接三台redis服务：</span></div><div>                            redis-cli -p 6379</div><div>                            redis-cli -p 6380</div><div>                            redis-cli -p 6381 </div><div>            <span style="font-weight: bold;">5、查看三台redis服务在集群中的主从角色：</span></div><div>                            info   replication     </div><div>                    默认情况下，所有的redis服务都是主机，即能读也能写，但是都还没有从机，三台redis服务互相独立，互不影响。</div><div>            <span style="font-weight: bold;">6、设置主从关系：设从不设主</span></div><div>                    在6380上执行：slaveof 127.0.0.1 6379</div><div>                    在6381上执行：slaveof 127.0.0.1 6379</div><div>            <span style="font-weight: bold;">7、全量复制：一旦主从关系确定，会自动把主机上已有的数据同步复制到从库。</span></div><div>                    在6380和6381上执行：keys *</div><div>            <span style="font-weight: bold;">8、增量复制：主写数据会自动同步到从库。</span></div><div>                    在6379上执行：set  k2 v2</div><div>                    在6380和6381上执行 keys *</div><div>            <span style="font-weight: bold;">9、主写从读，读写分离：</span></div><div>                    在6380和6381上执行：set k3 v3 ====&gt;报错</div><div>            <span style="font-weight: bold;">10、主机宕机：从机原地待命</span></div><div>          关闭6379服务：redis-cli -h 127.0.0.1 -p 6379 shutdown</div><div>           查看6380和6381服务的主从角色： info replication ：从机仍然从属于主机，但是master_link_status:down（连接状态变为了down）</div><div>            <span style="font-weight: bold;">11、主机恢复、一切恢复正常：</span></div><div>            重启6379服务：redis-server redis6379.conf &amp;</div><div>           从机状态变为了：master_link_status:up（连接状态恢复）</div><div>          <span style="font-weight: bold;">  12、从机宕机、主机少一个从机，其他从机不变</span></div><div>            关闭6380服务：redis-cli -h 127.0.0.1 -p 6380 shutdown</div><div>            查看6379服务的主从角色：info replication</div><div>            查看6381服务的主从角色：info replication</div><div>          <span style="font-weight: bold;">  13、从机恢复、需要重新设置从属关系：</span></div><div>            重启6380服务：redis-server redis6380.conf &amp;</div><div>            客户端连接6380：redis-cli -h 127.0.0.1 -p 6380</div><div>            查看6380服务的主从角色：info replication（6380变为了主机，不是从机了）</div><div>        </div><div>            在6380上执行：slaveof 127.0.0.1 6379    重新设置从属关系</div><div>          <span style="font-weight: bold;">  14、从机上位：</span></div><div>                1、主机宕机、从机原地待命：</div><div>            关闭6379服务：redis-cli -h 127.0.0.1 -p 6379 shutdown</div><div>            查看6380和6381的主从角色： info replication ：从机仍然从属于主机，但是master_link_status:down（连接状态变为了down）</div><div>                2、从机断开原来的主从关系：</div><div><span style="font-size: unset; color: unset; font-family: unset;">            在6380上执行：slaveof no one</span></div><div><span style="font-size: unset; color: unset; font-family: unset;">            查看6380服务的主从角色：info replication（变为了主机）    </span><span style="font-size: unset; color: unset; font-family: unset;">    </span><span style="font-size: unset; color: unset; font-family: unset;">    </span><span style="font-size: unset; color: unset; font-family: unset;">    </span></div><div>            重新设置主从关系：</div><div>            在6381上执行：slaveof 127.0.0.1 6380</div><div>      <span style="font-weight: bold;">  15、之前的主机恢复，变成了孤家寡人</span></div><div>                重启6379服务：redis-server redis6379.conf &amp;</div><div>                客户端连接6379：redis-cli -h 127.0.0.1 -p 6379</div><div>    <span style="font-weight: bold;">    16、将源主机6379设置为从机6381的从机（弟中弟）</span></div><div>            在6379上执行：slaveof 127.0.0.1 6381</div><div>            现在6381即是从机又是主机，但是还是不能写数据，有从角色的服务都不可以写。</div><div><br/></div><div>        <span style="font-size: 12pt; font-weight: bold;">小结：</span>一台主机配置多台从机，一台从机又可以配置多台从机，从而形成一个庞大的集群结构。减轻一台主机上的压力，但是增加了服务之间的延迟时间。</div><div><br/></div><div><br/></div><div><span style="font-size: 12pt; font-weight: bold;">redis哨兵模式：主机宕机、从机上位的自动版。</span></div><div>           </div><div>           <font style="font-size: 11pt;"><span style="font-size: 11pt; font-weight: bold;"> </span><span style="font-size: 11pt; font-weight: bold;">哨兵模式原理</span></font><span style="font-weight: bold;">：</span>从机上位的自动版。Redis提供了哨兵的命令，哨兵命令是一个独立的进程，哨兵通过发送命令来监控主从服务器的运行状态，如果检测到master故障了根据投票数自动将一个slave转换为 master,然后通过消息订阅模式通知其他slave，让他们切换主机。然而，一个哨兵进程对redis服务器进行监控，可能会出现问题，因此，可以使用更多的哨兵进行监控。</div><div>    </div><div>    1、搭建一主二从集群架构：（上述前五步）</div><div>    2、提供哨兵配置文件：</div><div>                在redis安装目录下创建配置文件：redis_sentinel.conf</div><div>    3、编辑哨兵配置文件：</div><div>                sentinel monitor dc-redis 127.0.0.1 6379 1，</div><div>                表示：指定监控主机的ip地址，post端口，得到哨兵的投票数（当哨兵投票数大于或者等于此数时切换主从关系）。 </div><div>            投票数表示哪个从机的投票数先达到指定票数，哪个从机就上位。</div><div>            投票机制最后投出的主机和各个机器的性能有关，一般设置的投票数越少上位越快。         </div><div>            默认的哨兵配置文件：sentinel.conf</div><div>    4、新开窗口，启动哨兵</div><div>            redis-sentinel 哨兵配置文件目录</div><div>    5、主机宕机</div><div>            关闭6379服务；</div><div>            哨兵程序自动选择从机上位。</div><div>    6、之前的主机恢复：</div><div>            重启6379服务；</div><div>            哨兵让其自动从属于新的主机。</div><div><img src="Redis的主从复制_files/Image.png" type="image/png" data-filename="Image.png" width="1397"/><br/></div><div>    </div><div><br/></div><div><br/></div><div>    </div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 