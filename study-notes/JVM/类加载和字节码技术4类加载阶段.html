<html>
<head>
  <title>类加载和字节码技术4&lt;类加载阶段&gt;</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/602916 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="3935"/>
<h1>类加载和字节码技术4&lt;类加载阶段&gt;</h1>

<div>
<span><div><span style="font-size: 14pt; font-weight: bold;">4、类加载阶段</span></div><div><br/></div><div><span style="font-size: 12pt; font-weight: bold;">4、1 加载</span></div><div><img src="类加载和字节码技术4类加载阶段_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><img src="类加载和字节码技术4类加载阶段_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><span style="font-size: 12pt; font-weight: bold;">4、2 链接</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt; font-weight: bold;">链接阶段第一步</span><span style="font-size: 11pt; font-weight: bold;">：验证，验证类是否符合JVM规范，安全性检查</span></div><div><img src="类加载和字节码技术4类加载阶段_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div><span style="font-size: 12pt; font-weight: bold;">链接阶段第二步：</span><span style="font-size: 11pt; font-weight: bold;">准备，为static变量分配空间，设置默认值</span></div><div><img src="类加载和字节码技术4类加载阶段_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>static final String d=&quot;hello&quot;;//是在准备阶段就赋值完成的</div></div><div><span style="font-size: 12pt; font-weight: bold;">链接阶段第三步：</span><span style="font-size: 11pt; font-weight: bold;">解析，将常量池中的符号引用解析为直接引用</span></div><div><img src="类加载和字节码技术4类加载阶段_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>ClassLoader 中的loadClass并不会导致类的解析和初始化，只是类加载。</div><div>new() 会导致类的加载，解析和初始化。</div></div><div><font style="font-size: 14pt;"><br/></font></div><div><span style="font-size: 14pt; font-weight: bold;">4、3 初始化</span></div><div><span style="font-size: 12pt; font-weight: bold;">&lt;cinit&gt;&lt;&gt;V 方法</span></div><div><span style="font-size: 11pt;">初始化调用&lt;cinit&gt;()V,虚拟机会保证这个类的【构造方法】的线程安全。</span></div><div><font style="font-size: 11pt;"><br/></font></div><div><span style="font-size: 12pt; font-weight: bold;">发生的时机</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;"><img src="类加载和字节码技术4类加载阶段_files/Image [5].png" type="image/png" data-filename="Image.png"/></span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">4、4 练习</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;"><img src="类加载和字节码技术4类加载阶段_files/Image [6].png" type="image/png" data-filename="Image.png"/></span></span></div><div><span style="font-size: 16px;"><span style="font-size: 16px; font-weight: bold;">练习2</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;"><img src="类加载和字节码技术4类加载阶段_files/Image [7].png" type="image/png" data-filename="Image.png"/></span></span></div><div><font style="font-size: 14pt;"><br/></font></div><div><span style="font-size: 14pt; font-weight: bold;">5、类加载器</span></div><div><span style="font-size: 18.6667px;">双亲委派机制</span></div><div><span style="font-size: 14pt;"><a href="https://blog.csdn.net/sillyzhangye/article/details/106516222">https://blog.csdn.net/sillyzhangye/article/details/106516222</a></span></div><div><span style="font-size: 11pt; font-weight: bold;">双亲委派的类加载模式</span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;"><img src="类加载和字节码技术4类加载阶段_files/Image [8].png" type="image/png" data-filename="Image.png"/></span></span></div><div><span style="font-size: 11pt; font-weight: bold;">自定义类加载器--&gt;应用程序类加载器--&gt;扩展类加载器---&gt;启动类加载器（从下到上）</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">5、1 启动类加载器</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;"><img src="类加载和字节码技术4类加载阶段_files/Image [9].png" type="image/png" data-filename="Image.png"/></span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;"><img src="类加载和字节码技术4类加载阶段_files/Image [10].png" type="image/png" data-filename="Image.png"/></span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;"><img src="类加载和字节码技术4类加载阶段_files/Image [11].png" type="image/png" data-filename="Image.png"/></span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">5、2 扩展类加载器</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;"><img src="类加载和字节码技术4类加载阶段_files/Image [12].png" type="image/png" data-filename="Image.png"/></span></span></div><div><span style="font-size: 16px;"><span style="font-size: 16px; font-weight: bold;">扩展类加载器加载的类都是.jar 包</span></span></div><div><span style="font-size: 16px;"><br/></span></div><div><span style="font-size: 16px;"><span style="font-size: 16px; font-weight: bold;">JVM打包为.jar的指令：jar -cvf my.jar 类路径</span></span></div><div><span style="font-size: 16px;"><span style="font-size: 16px; font-weight: bold;">删除指令：del my.jar</span></span></div><div><span style="font-size: 16px;"><br/></span></div><div><span style="font-size: 16px;"><br/></span></div><div><span style="font-size: 16px;"><span style="font-size: 16px; font-weight: bold;">5、3 双亲委派模式</span></span></div><div><span style="font-size: 16px;"><br/></span></div><div><span style="font-size: 10pt; font-weight: bold;">所谓的双亲委派，就是指调用类加载器的 loadClass方法时，查找类的规则</span></div><div><span style="font-size: 16px;"><span style="font-size: 16px; font-weight: bold;">    注意：</span></span></div><div><span style="font-size: 11pt; font-weight: bold;">这里的双亲，翻译为上级似乎更为合适，因为他们并没有继承关系</span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [13].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [14].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;">5、4 线程上下文类加载器</span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [15].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [16].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [17].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [18].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 16px;">有时候JDK需要打破双亲委派机制，通过线程上下文类加载器（默认是应用程序类加载器）。</span><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [19].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [20].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [21].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [22].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [23].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">5、5 自定义类加载器</span></span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [24].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [25].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [26].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 16px;">唯一确定类的方式：</span></div><div><span style="font-size: 16px;">    包名相同；类名相同；是同一个类加载器。</span></div><div><br/></div><div><span style="font-size: 16px;">不同的类加载器加载同一个类，会认为类是相互隔离的。</span></div><div><span style="font-size: 16px;"><br/></span></div><div><span style="font-size: 14pt; font-weight: bold;">6、运行时优化</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">6、1 即时编译</span></span></div><div><span style="font-size: 16px;">分层编译</span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [27].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [28].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [29].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 16px;">上述例子的逃逸分析指的是：</span></div><div><span style="font-size: 16px;">    创建出的对象并没有影响到外界对象，没必要创建。</span></div><div><span style="font-size: 16px;">关闭逃逸分析</span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [30].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 16px;">关闭逃逸分析之后：代码执行的时间并没有减少到三位数。</span></div><div><span style="font-size: 16px;">方法内联</span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [31].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [32].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 14pt; font-weight: bold;">字段优化</span></div><div><span style="font-size: 16px;"><br/></span></div><div><span style="font-size: 14pt; font-weight: bold;">6、2 </span><span style="font-size: 14pt; color: unset; font-family: unset; font-weight: bold;">反射优化：</span></div><div><span style="font-size: 12pt;"><img src="类加载和字节码技术4类加载阶段_files/Image [33].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-size: 12pt;"><br/></span></div></span>
</div></body></html> 