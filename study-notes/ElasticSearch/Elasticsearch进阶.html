<html>
<head>
  <title>Elasticsearch进阶</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/602916 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="5876"/>
<h1>Elasticsearch进阶</h1>

<div>
<span><div><font style="font-size: 14pt;"><span style="font-size: 14pt; font-style: italic; font-weight: bold;">一、核心概念</span></font></div><div>    <span style="font-size: 12pt; color: rgb(70, 70, 70); font-weight: bold;">索引</span><img src="Elasticsearch进阶_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><span style="font-size: 12pt; font-weight: bold;">    类型（在最新的版本已经不在支持了）</span></div><div><img src="Elasticsearch进阶_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div>      <span style="font-size: 12pt; font-weight: bold;">文档（Document）</span></div><div><img src="Elasticsearch进阶_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div>    <font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;"> 字段（Field）</span></font></div><div><img src="Elasticsearch进阶_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div>      <span style="font-size: 12pt; color: rgb(70, 70, 70); font-weight: bold;">映射（Mapping）</span></div><div><img src="Elasticsearch进阶_files/Image [5].png" type="image/png" data-filename="Image.png"/></div><div>    <span style="font-size: 12pt; font-weight: bold;">  分片（Shards）</span></div><div><img src="Elasticsearch进阶_files/Image [6].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [7].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [8].png" type="image/png" data-filename="Image.png"/></div><div>      <span style="font-size: 12pt; font-weight: bold;">  副本（Replicas）</span></div><div><img src="Elasticsearch进阶_files/Image [9].png" type="image/png" data-filename="Image.png"/></div><div><span style="font-size: 14pt;"><img src="Elasticsearch进阶_files/Image [10].png" type="image/png" data-filename="Image.png"/></span></div><div>       <span style="font-size: 12pt; font-weight: bold;">分配（Allocation）</span></div><div><img src="Elasticsearch进阶_files/Image [11].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt; font-style: italic;">    二、</span><span style="font-size: 14pt; font-style: italic; font-weight: bold;">系统架构</span></font></div><div><img src="Elasticsearch进阶_files/Image [12].png" type="image/png" data-filename="Image.png"/></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt; font-style: italic; font-weight: bold;">    三、分布式集群</span></font></div><div>        <span style="font-size: 12pt; font-weight: bold;">单节点集群</span></div><div><img src="Elasticsearch进阶_files/Image [13].png" type="image/png" data-filename="Image.png"/></div><div><span style="color: rgb(227, 0, 0); font-weight: bold;">         默认情况下，索引的分片是一，副本是一。</span></div><div><img src="Elasticsearch进阶_files/Image [14].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [15].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [16].png" type="image/png" data-filename="Image.png"/></div><div>（一个分片对应一个副本，分片和副本应该在不同的节点（防止数据丢失），在单点情况下，数据和副本在一台机器上，这是不安全的，集群健康值为yellow）</div><div><span style="font-size: 12pt; color: rgb(70, 70, 70); font-weight: bold;">    故障转移</span></div><div><img src="Elasticsearch进阶_files/Image [17].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [18].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [19].png" type="image/png" data-filename="Image.png"/></div><div>    (边框粗的是主分片，细的是副本)</div><div><br/></div><div>    <font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">水平扩容</span></font></div><div><img src="Elasticsearch进阶_files/Image [20].png" type="image/png" data-filename="Image.png"/></div><div>再次加入一个节点</div><div><img src="Elasticsearch进阶_files/Image [21].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [22].png" type="image/png" data-filename="Image.png"/></div><div><span style="color: rgb(227, 0, 0); font-weight: bold;">    注：该索引上的每个分片都有了两个副本</span><span style="color: rgb(227, 0, 0);">。</span></div><div><img src="Elasticsearch进阶_files/Image [23].png" type="image/png" data-filename="Image.png"/></div><div>    <span style="font-size: 12pt; font-weight: bold;">应对故障</span></div><div>    假设上述集群（三个节点）中原先的master节点宕机。</div><div><img src="Elasticsearch进阶_files/Image [24].png" type="image/png" data-filename="Image.png"/></div><div>    <span style="font-size: 12pt; font-weight: bold;">路由计算</span></div><div>        </div><div>        在分片中的文档数据，它的插入和查询应该有一个统一的规则。这个规则就是路由计算。（<span style="font-weight: bold;">新增文档的时候，增加在哪个分片？</span>）</div><div>        路由计算：hash(id)%主分片数量</div><div><img src="Elasticsearch进阶_files/Image [25].png" type="image/png" data-filename="Image.png"/></div><div>        <span style="font-weight: bold;">查询文档</span>：（<span style="font-weight: bold;">通过路由计算可以直到指定文档在哪个分片，但查询分片还是查询分片的副本呢？</span>）</div><div>    <img src="Elasticsearch进阶_files/Image [26].png" type="image/png" data-filename="Image.png"/></div><div>   </div><div>     <span style="font-size: 12pt; color: rgb(70, 70, 70); font-weight: bold;">数据写流程</span></div><div><img src="Elasticsearch进阶_files/Image [27].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [28].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [29].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [30].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [31].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [32].png" type="image/png" data-filename="Image.png"/></div><div>    <font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">数据读流程</span></font></div><div><img src="Elasticsearch进阶_files/Image [33].png" type="image/png" data-filename="Image.png"/></div><div>    <span style="font-size: 12pt; font-weight: bold;">数据更新流程</span></div><div><img src="Elasticsearch进阶_files/Image [34].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [35].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [36].png" type="image/png" data-filename="Image.png"/></div><div>       <font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;"> </span><span style="font-size: 12pt; font-weight: bold;">多文档操作流程</span></font></div><div><img src="Elasticsearch进阶_files/Image [37].png" type="image/png" data-filename="Image.png"/></div><div>      <font style="font-size: 14pt;"><span style="font-size: 14pt; font-style: italic; font-weight: bold;">  四、分片原理</span></font></div><div><img src="Elasticsearch进阶_files/Image [38].png" type="image/png" data-filename="Image.png"/></div><div>      <font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">  倒排索引</span></font></div><div><img src="Elasticsearch进阶_files/Image [39].png" type="image/png" data-filename="Image.png"/></div><div><span style="font-weight: bold;">分词器：</span></div><div>    keyword：</div><div>    text：</div><div>    </div><div>    ik_max_word：最粗粒度拆分</div><div>    ik_smart：最细粒度的拆分</div><div><span style="font-weight: bold;">词条：</span>索引中最小存储和查询单元</div><div><span style="font-weight: bold;">词典：</span>字典，词条的集合。底层有两种存储方式：B+,HashMap</div><div><span style="font-weight: bold;">倒排表：</span>词条和文档ID的映射表。</div><div><br/></div><div>        <span style="font-size: 14pt; font-weight: bold;">文档搜索</span></div><div><img src="Elasticsearch进阶_files/Image [40].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [41].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [42].png" type="image/png" data-filename="Image.png"/></div><div>        <span style="font-weight: bold;">动态更新索引</span></div><div><img src="Elasticsearch进阶_files/Image [43].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [44].png" type="image/png" data-filename="Image.png"/></div><div>    按段搜索会以如下流程执行：</div><div>    <img src="Elasticsearch进阶_files/Image [45].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [46].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [47].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [48].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [49].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [50].png" type="image/png" data-filename="Image.png"/></div><div>    <span style="font-size: 10pt; font-weight: bold;">近实时搜索</span></div><div><img src="Elasticsearch进阶_files/Image [51].png" type="image/png" data-filename="Image.png"/></div><div>    <span style="font-weight: bold;">演示</span></div><div><img src="Elasticsearch进阶_files/Image [52].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [53].png" type="image/png" data-filename="Image.png"/></div><div>    索引在Memory（内存）中写入Segment对象，并flush到磁盘的Segment文件。为了防止flush过程的特殊情况导致数据丢失（宕机），ES学习数据库对这种情况的处理（建立日志）。但是<span style="font-size: unset; color: unset; font-family: unset;">ES和数据库不同的是，数据库是写入日志，在写入内存；而ES是先写入内存，在写入日志。一种可能的原因是ES作为搜索引擎，它的写入内存有很复杂的逻辑（分词，过滤，转换），很容易失败，为了避免Translog中存在大量的无效记录（先存入日志，写入失败，就会存入无效数据），所以ES先写内存再写日志。这不同于Hadoop中HBase的日志先行（先日志在内存）。</span></div><div><br/></div><div>    上图存在问题：效率较低，必须将Segment写入磁盘才能进行读取操作，而磁盘的IO操作效率较低</div><div>    解决方案：在中间加一层操作系统的文件缓冲区</div><div><img src="Elasticsearch进阶_files/Image [54].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>    <span style="font-size: 12pt; font-weight: bold;">文档分析</span></div><div><img src="Elasticsearch进阶_files/Image [55].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [56].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [57].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [58].png" type="image/png" data-filename="Image.png"/></div><div><span style="font-weight: bold;">    内置分析器</span></div><div><img src="Elasticsearch进阶_files/Image [59].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [60].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [61].png" type="image/png" data-filename="Image.png"/></div><div>    <span style="font-size: 10pt; font-weight: bold;">分析器使用场景</span></div><div><img src="Elasticsearch进阶_files/Image [62].png" type="image/png" data-filename="Image.png"/></div><div>        需要注意的是：在存储的时候做出的分词操作，在查询的使用应该使用相同的操作。</div><div>    <span style="font-weight: bold;">测试分析器</span></div><div><img src="Elasticsearch进阶_files/Image [63].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [64].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [65].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [66].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [67].png" type="image/png" data-filename="Image.png"/></div><div>    <span style="font-size: 11pt; font-weight: bold;">指定分析器</span></div><div><img src="Elasticsearch进阶_files/Image [68].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [69].png" type="image/png" data-filename="Image.png"/></div><div>    <span style="font-weight: bold;">IK分词器（中文分词器）</span></div><div><img src="Elasticsearch进阶_files/Image [70].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [71].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [72].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [73].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [74].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [75].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [76].png" type="image/png" data-filename="Image.png"/></div><div><span style="font-weight: bold;">    自定义分析器</span></div><div><img src="Elasticsearch进阶_files/Image [77].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [78].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [79].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [80].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [81].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [82].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [83].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [84].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [85].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><span style="font-size: 14pt; font-weight: bold;">文档处理</span></div><div><br/></div><div>    <span style="font-size: 12pt; font-weight: bold;">文档冲突</span></div><div><img src="Elasticsearch进阶_files/Image [86].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [87].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [88].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [89].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [90].png" type="image/png" data-filename="Image.png"/></div><div>    </div><div>    <span style="font-size: 12pt; font-weight: bold;">乐观并发控制</span></div><div><img src="Elasticsearch进阶_files/Image [91].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [92].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [93].png" type="image/png" data-filename="Image.png"/></div><div>  <span style="font-size: 12pt; font-weight: bold;">  外部系统版本控制</span></div><div><img src="Elasticsearch进阶_files/Image [94].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><span style="font-size: 14pt; font-weight: bold;">    五、Kibana</span></div><div><img src="Elasticsearch进阶_files/Image [95].png" type="image/png" data-filename="Image.png"/></div><div><img src="Elasticsearch进阶_files/Image [96].png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># 默认端口</div><div>server.port: 5601</div><div># ES服务器的地址</div><div>elasticsearch.hosts: [&quot;http://localhost:1001&quot;,&quot;http://localhost:1002&quot;,&quot;http://localhost:1003&quot;]</div><div># 索引名</div><div>kibana.index: &quot;.kibana&quot;</div><div># 支持中文</div><div>i18n.locale: &quot;zh-CN&quot;</div></div><div><img src="Elasticsearch进阶_files/Image [97].png" type="image/png" data-filename="Image.png"/></div><div><br/></div></span>
</div></body></html> 